{% extends "base.html" %}

{% block title %}Dashboard - Sistema IEDI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard IEDI</h1>
    <p>√çndice de Exposi√ß√£o Digital na Imprensa</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üè¶</div>
        <div class="stat-content">
            <h3 id="total-bancos">0</h3>
            <p>Bancos Cadastrados</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üì∞</div>
        <div class="stat-content">
            <h3 id="total-veiculos">0</h3>
            <p>Ve√≠culos Monitorados</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
            <h3 id="total-analises">0</h3>
            <p>An√°lises Realizadas</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üë§</div>
        <div class="stat-content">
            <h3 id="total-portavozes">0</h3>
            <p>Porta-vozes</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>√öltimas An√°lises</h2>
        <a href="/analises" class="btn btn-secondary">Ver Todas</a>
    </div>
    <div class="card-body">
        <div id="ultimas-analises">
            <p class="text-muted">Carregando...</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>In√≠cio R√°pido</h2>
    </div>
    <div class="card-body">
        <div class="quick-actions">
            <button onclick="seedData()" class="btn btn-primary">
                üå± Carregar Dados Iniciais
            </button>
            <a href="/bancos" class="btn btn-secondary">
                üè¶ Gerenciar Bancos
            </a>
            <a href="/veiculos" class="btn btn-secondary">
                üì∞ Gerenciar Ve√≠culos
            </a>
            <a href="/configuracoes" class="btn btn-secondary">
                ‚öôÔ∏è Configura√ß√µes
            </a>
        </div>
        <div class="alert alert-info" style="margin-top: 20px;">
            <strong>Bem-vindo ao Sistema IEDI!</strong><br>
            Para come√ßar, carregue os dados iniciais e configure os bancos e ve√≠culos que deseja monitorar.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadDashboardStats() {
    try {
        const [bancos, veiculos, analises, portaVozes] = await Promise.all([
            fetch('/api/bancos').then(r => r.json()),
            fetch('/api/veiculos-relevantes').then(r => r.json()),
            fetch('/api/analises').then(r => r.json()),
            fetch('/api/porta-vozes').then(r => r.json())
        ]);
        
        document.getElementById('total-bancos').textContent = bancos.length;
        document.getElementById('total-veiculos').textContent = veiculos.length;
        document.getElementById('total-analises').textContent = analises.length;
        document.getElementById('total-portavozes').textContent = portaVozes.length;
        
        // Mostrar √∫ltimas an√°lises
        const ultimasDiv = document.getElementById('ultimas-analises');
        if (analises.length === 0) {
            ultimasDiv.innerHTML = '<p class="text-muted">Nenhuma an√°lise realizada ainda.</p>';
        } else {
            const html = analises.slice(0, 5).map(a => `
                <div class="analise-item">
                    <div class="analise-info">
                        <strong>An√°lise #${a.id}</strong>
                        <span class="badge badge-${a.status}">${a.status}</span>
                    </div>
                    <div class="analise-meta">
                        ${formatDate(a.data_inicio)} - ${formatDate(a.data_fim)}
                        <span class="text-muted">${a.total_mencoes || 0} men√ß√µes</span>
                    </div>
                    <a href="/analise/${a.id}" class="btn btn-sm btn-secondary">Ver Detalhes</a>
                </div>
            `).join('');
            ultimasDiv.innerHTML = html;
        }
    } catch (error) {
        console.error('Erro ao carregar stats:', error);
    }
}

async function seedData() {
    if (!confirm('Deseja carregar os dados iniciais? Isso criar√° bancos e ve√≠culos de exemplo.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/seed', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Dados iniciais carregados com sucesso!');
            loadDashboardStats();
        } else {
            alert('Erro: ' + result.error);
        }
    } catch (error) {
        alert('Erro ao carregar dados: ' + error.message);
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('pt-BR');
}

// Carregar ao iniciar
loadDashboardStats();
</script>
{% endblock %}
