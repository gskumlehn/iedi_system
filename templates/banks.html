{% extends "base.html" %}

{% block title %}Bancos - IEDI{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title-wrapper">
        <svg class="page-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        <div>
            <h1 class="page-title">Bancos</h1>
            <p class="page-description">Gerencie bancos e suas variações de nome</p>
        </div>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Novo Banco
    </button>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Lista de Bancos</h2>
        <p class="card-description" id="banco-count">0 banco(s) cadastrado(s)</p>
    </div>
    <div class="card-content">
        <div id="loading" class="loading">Carregando...</div>
        <div id="empty-state" class="empty-state hidden">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <p class="empty-state-title">Nenhum banco cadastrado</p>
            <p class="empty-state-description">Clique em "Novo Banco" para começar</p>
        </div>
        <div id="table-container" class="table-container hidden">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Variações</th>
                        <th>Status</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="bancos-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Criar/Editar -->
<div id="banco-modal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Novo Banco</h2>
            <p class="modal-description">Preencha os dados do banco</p>
        </div>
        <form id="banco-form" onsubmit="handleSubmit(event)">
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome *</label>
                    <input type="text" id="nome" class="form-input" placeholder="Ex: Banco do Brasil" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="variacoes">Variações (uma por linha)</label>
                    <textarea id="variacoes" class="form-textarea" placeholder="Ex:&#10;BB&#10;Banco do Brasil&#10;BancoDoBrasil"></textarea>
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">
                        <input type="checkbox" id="ativo" checked>
                        Ativo
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('banco-modal')">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="submit-btn">Criar</button>
            </div>
        </form>
    </div>
</div>

<script>
let bancos = [];
let editingId = null;

async function loadBancos() {
    try {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('table-container').classList.add('hidden');
        
        bancos = await apiRequest('/banks/api');
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('banco-count').textContent = `${bancos.length} banco(s) cadastrado(s)`;
        
        if (bancos.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            document.getElementById('table-container').classList.remove('hidden');
            renderBancos();
        }
    } catch (error) {
        document.getElementById('loading').classList.add('hidden');
        showToast('Erro ao carregar bancos', 'error');
    }
}

function renderBancos() {
    const tbody = document.getElementById('bancos-tbody');
    tbody.innerHTML = bancos.map(banco => `
        <tr>
            <td><strong>${banco.nome}</strong></td>
            <td>
                <span class="text-muted">
                    ${banco.variacoes.length} variação(ões)
                </span>
            </td>
            <td>
                <span class="badge ${banco.ativo ? 'badge-success' : 'badge-secondary'}">
                    ${banco.ativo ? 'Ativo' : 'Inativo'}
                </span>
            </td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-secondary btn-sm" onclick="openEditModal(${banco.id})">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="handleDelete(${banco.id}, '${banco.nome}')">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function openCreateModal() {
    editingId = null;
    document.getElementById('modal-title').textContent = 'Novo Banco';
    document.getElementById('submit-btn').textContent = 'Criar';
    document.getElementById('banco-form').reset();
    document.getElementById('active').checked = true;
    openModal('banco-modal');
}

function openEditModal(id) {
    const banco = bancos.find(b => b.id === id);
    if (!banco) return;
    
    editingId = id;
    document.getElementById('modal-title').textContent = 'Editar Banco';
    document.getElementById('submit-btn').textContent = 'Atualizar';
    document.getElementById('name').value = banco.nome;
    document.getElementById('variations').value = banco.variacoes.join('\n');
    document.getElementById('active').checked = banco.ativo;
    openModal('banco-modal');
}

async function handleSubmit(event) {
    event.preventDefault();
    
    const nome = document.getElementById('name').value.trim();
    const variacoesText = document.getElementById('variations').value.trim();
    const variacoes = variacoesText ? variacoesText.split('\n').map(v => v.trim()).filter(v => v) : [];
    const ativo = document.getElementById('active').checked;
    
    const data = { nome, variacoes, ativo };
    
    try {
        if (editingId) {
            await apiRequest(`/banks/api/${editingId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });
            showToast('Banco atualizado com sucesso!', 'success');
        } else {
            await apiRequest('/banks/api', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            showToast('Banco criado com sucesso!', 'success');
        }
        
        closeModal('banco-modal');
        loadBancos();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function handleDelete(id, nome) {
    if (!confirmAction(`Tem certeza que deseja excluir o banco "${nome}"?`)) {
        return;
    }
    
    try {
        await apiRequest(`/banks/api/${id}`, { method: 'DELETE' });
        showToast('Banco excluído com sucesso!', 'success');
        loadBancos();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

document.addEventListener('DOMContentLoaded', loadBancos);
</script>
{% endblock %}
