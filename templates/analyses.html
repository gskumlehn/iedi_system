{% extends "base.html" %}

{% block title %}Análises IEDI - IEDI{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title-wrapper">
        <svg class="page-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
        <div>
            <h1 class="page-title">Análises IEDI</h1>
            <p class="page-description">Visualize análises e resultados do Índice de Exposição Digital na Imprensa</p>
        </div>
    </div>
</div>

<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Total de Análises</span>
            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
        </div>
        <div class="stat-value" id="stat-total">0</div>
        <p class="stat-description">Análises realizadas</p>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Última Análise</span>
            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </div>
        <div class="stat-value" id="stat-ultima" style="font-size: 1.25rem;">-</div>
        <p class="stat-description">Data da última análise</p>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-title">Concluídas</span>
            <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <div class="stat-value" id="stat-concluidas">0</div>
        <p class="stat-description" id="stat-concluidas-desc">De 0 total</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Histórico de Análises</h2>
        <p class="card-description" id="analise-count">0 análise(s) realizada(s)</p>
    </div>
    <div class="card-content">
        <div id="loading" class="loading">Carregando...</div>
        <div id="empty-state" class="empty-state hidden">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
            <p class="empty-state-title">Nenhuma análise realizada ainda</p>
            <p class="empty-state-description">As análises IEDI serão exibidas aqui quando forem executadas</p>
        </div>
        <div id="table-container" class="table-container hidden">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Período</th>
                        <th>Status</th>
                        <th>Data de Criação</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="analises-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h2 class="card-title">Sobre as Análises IEDI</h2>
        <p class="card-description">Entenda como funciona o cálculo do índice</p>
    </div>
    <div class="card-content">
        <p class="text-muted mb-2">
            O <strong>IEDI (Índice de Exposição Digital na Imprensa)</strong> mede a presença
            de bancos na mídia digital brasileira, considerando fatores como:
        </p>
        <ul style="list-style: disc; margin-left: 1.5rem; color: var(--gray-600);">
            <li>Presença em veículos relevantes (grupos A, B, C, D por alcance)</li>
            <li>Presença em veículos de nicho especializados</li>
            <li>Posicionamento nas matérias (título, subtítulo)</li>
            <li>Sentimento das menções (positivo, neutro, negativo)</li>
            <li>Balizamento por proporção de menções positivas</li>
        </ul>
        <p class="text-muted mt-2">
            Cada análise processa menções coletadas em períodos de divulgação de resultados
            dos bancos, aplicando pesos específicos e calculando o índice final para cada instituição.
        </p>
    </div>
</div>

<script>
let analises = [];

async function loadAnalises() {
    try {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('table-container').classList.add('hidden');
        
        analises = await apiRequest('/analyses/api');
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('analise-count').textContent = `${analises.length} análise(s) realizada(s)`;
        
        // Atualizar estatísticas
        document.getElementById('stat-total').textContent = analises.length;
        
        if (analises.length > 0) {
            const ultima = analises[analises.length - 1];
            document.getElementById('stat-ultima').textContent = formatDate(ultima.data_criacao);
            
            const concluidas = analises.filter(a => a.status === 'completed').length;
            document.getElementById('stat-concluidas').textContent = concluidas;
            document.getElementById('stat-concluidas-desc').textContent = `De ${analises.length} total`;
            
            document.getElementById('table-container').classList.remove('hidden');
            renderAnalises();
        } else {
            document.getElementById('empty-state').classList.remove('hidden');
        }
    } catch (error) {
        document.getElementById('loading').classList.add('hidden');
        showToast('Erro ao carregar análises', 'error');
    }
}

function renderAnalises() {
    const tbody = document.getElementById('analises-tbody');
    tbody.innerHTML = analises.map(analise => {
        const statusClass = 
            analise.status === 'completed' ? 'badge-success' :
            analise.status === 'failed' ? 'badge-danger' :
            analise.status === 'running' ? 'badge-info' :
            'badge-secondary';
        
        const statusText = 
            analise.status === 'completed' ? 'Concluída' :
            analise.status === 'failed' ? 'Falhou' :
            analise.status === 'running' ? 'Executando' :
            'Pendente';
        
        return `
            <tr>
                <td><strong>#${analise.id}</strong></td>
                <td>
                    ${formatDate(analise.data_inicio)} - ${formatDate(analise.data_fim)}
                </td>
                <td>
                    <span class="badge ${statusClass}">${statusText}</span>
                </td>
                <td>${formatDateTime(analise.data_criacao)}</td>
                <td>
                    <div class="table-actions">
                        <a href="/analise/${analise.id}" class="btn btn-secondary btn-sm">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </a>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

document.addEventListener('DOMContentLoaded', loadAnalises);
</script>
{% endblock %}
