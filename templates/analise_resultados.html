{% extends "base.html" %}

{% block title %}An√°lise de Resultados - Sistema IEDI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üè¶ An√°lise de Resultados Trimestrais</h1>
    <p>An√°lise IEDI com per√≠odos diferentes por banco (divulga√ß√£o de resultados)</p>
</div>

<div id="status-alert" class="alert alert-info" style="display:none;"></div>

<!-- Card de Configura√ß√£o Brandwatch -->
<div class="card">
    <div class="card-header">
        <h2>1. Configura√ß√£o Brandwatch</h2>
    </div>
    <div class="card-body">
        <div id="brandwatch-status">
            <p class="text-muted">Verificando status...</p>
        </div>
        
        <form id="config-form" style="display:none; margin-top:20px;">
            <div class="form-group">
                <label for="bw-email">Email Brandwatch *</label>
                <input type="email" id="bw-email" required>
            </div>
            
            <div class="form-group">
                <label for="bw-password">Senha *</label>
                <input type="password" id="bw-password" required>
            </div>
            
            <div class="form-group">
                <label for="bw-project">ID do Projeto *</label>
                <input type="text" id="bw-project" required>
            </div>
            
            <div class="form-group">
                <label for="bw-query">Nome da Query Geral *</label>
                <input type="text" id="bw-query" required placeholder="Query com todos os bancos">
                <small class="form-text">Query geral que cont√©m todos os bancos, com categoryDetail configurado</small>
            </div>
            
            <button type="submit" class="btn btn-primary">Salvar Configura√ß√£o</button>
        </form>
    </div>
</div>

<!-- Card de Configura√ß√£o da An√°lise -->
<div class="card">
    <div class="card-header">
        <h2>2. Configurar An√°lise de Resultados</h2>
    </div>
    <div class="card-body">
        <form id="analise-form">
            <div class="form-group">
                <label for="periodo-ref">Per√≠odo de Refer√™ncia *</label>
                <input type="text" id="periodo-ref" required placeholder="Ex: 1T2025, 2T2025, 4T2024">
                <small class="form-text">Identifica√ß√£o do trimestre/per√≠odo analisado</small>
            </div>
            
            <div class="form-group">
                <label for="query-override">Nome da Query (opcional)</label>
                <input type="text" id="query-override" placeholder="Deixe vazio para usar a configura√ß√£o padr√£o">
                <small class="form-text">Sobrescreve a query configurada acima</small>
            </div>
            
            <hr style="margin:30px 0;">
            
            <h3 style="margin-bottom:20px;">Per√≠odos de Coleta por Banco</h3>
            <p class="text-muted">Configure a data de divulga√ß√£o e per√≠odo de coleta para cada banco</p>
            
            <div id="bancos-container">
                <p class="text-muted">Carregando bancos...</p>
            </div>
            
            <div id="progress-info" style="display:none; margin:30px 0;">
                <div class="alert alert-info">
                    <strong>Processando...</strong><br>
                    <span id="progress-text">Extraindo men√ß√µes da Brandwatch...</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" id="btn-executar" style="margin-top:20px;">
                üöÄ Executar An√°lise de Resultados
            </button>
        </form>
    </div>
</div>

<!-- Card de Resultado -->
<div id="resultado-card" class="card" style="display:none;">
    <div class="card-header">
        <h2>Resultado da An√°lise</h2>
    </div>
    <div class="card-body">
        <div id="resultado-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let bwConfigured = false;
let bancosData = [];

async function checkBrandwatchStatus() {
    try {
        const response = await fetch('/api/brandwatch/status');
        const status = await response.json();
        
        const statusDiv = document.getElementById('brandwatch-status');
        const configForm = document.getElementById('config-form');
        
        if (!status.available) {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ö†Ô∏è Brandwatch API n√£o dispon√≠vel</strong><br>
                    A biblioteca bcr-api n√£o est√° instalada. Instale com:<br>
                    <code>pip install bcr-api</code>
                </div>
            `;
            document.getElementById('analise-form').style.display = 'none';
            return;
        }
        
        if (status.configured) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ Brandwatch configurado</strong><br>
                    Sistema pronto para extrair men√ß√µes.
                    <button onclick="showConfigForm()" class="btn btn-sm btn-secondary" style="margin-left:10px;">
                        Alterar Configura√ß√£o
                    </button>
                </div>
            `;
            bwConfigured = true;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Configura√ß√£o necess√°ria</strong><br>
                    Configure as credenciais da Brandwatch para continuar.
                    <button onclick="showConfigForm()" class="btn btn-sm btn-primary" style="margin-left:10px;">
                        Configurar Agora
                    </button>
                </div>
            `;
            bwConfigured = false;
        }
    } catch (error) {
        console.error('Erro ao verificar status:', error);
    }
}

function showConfigForm() {
    document.getElementById('config-form').style.display = 'block';
}

async function loadBancos() {
    try {
        const response = await fetch('/api/bancos');
        const bancos = await response.json();
        bancosData = bancos;
        
        const container = document.getElementById('bancos-container');
        
        if (bancos.length === 0) {
            container.innerHTML = `
                <div class="alert alert-warning">
                    Nenhum banco cadastrado. <a href="/bancos">Cadastre bancos primeiro</a>.
                </div>
            `;
            return;
        }
        
        let html = '<div style="display:grid;gap:20px;">';
        
        bancos.forEach(banco => {
            html += `
                <div class="banco-periodo-card" style="border:1px solid #ddd;padding:20px;border-radius:8px;background:#f9f9f9;">
                    <h4 style="margin:0 0 15px 0;">${banco.nome}</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div class="form-group" style="margin:0;">
                            <label>Data de Divulga√ß√£o *</label>
                            <input type="date" 
                                   class="banco-divulgacao" 
                                   data-banco-id="${banco.id}" 
                                   required>
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label>Dias de Coleta *</label>
                            <input type="number" 
                                   class="banco-dias-coleta" 
                                   data-banco-id="${banco.id}" 
                                   value="2" 
                                   min="1" 
                                   max="30" 
                                   required>
                            <small class="form-text">Quantos dias coletar ap√≥s a divulga√ß√£o</small>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <small class="text-muted">
                            <strong>Per√≠odo calculado:</strong> 
                            <span class="periodo-calculado" data-banco-id="${banco.id}">
                                Defina a data de divulga√ß√£o
                            </span>
                        </small>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Adicionar listeners para calcular per√≠odo
        document.querySelectorAll('.banco-divulgacao, .banco-dias-coleta').forEach(input => {
            input.addEventListener('change', updatePeriodoCalculado);
            input.addEventListener('input', updatePeriodoCalculado);
        });
        
    } catch (error) {
        console.error('Erro ao carregar bancos:', error);
        document.getElementById('bancos-container').innerHTML = `
            <div class="alert alert-danger">
                Erro ao carregar bancos: ${error.message}
            </div>
        `;
    }
}

function updatePeriodoCalculado(event) {
    const bancoId = event.target.dataset.bancoId;
    const divulgacaoInput = document.querySelector(`.banco-divulgacao[data-banco-id="${bancoId}"]`);
    const diasInput = document.querySelector(`.banco-dias-coleta[data-banco-id="${bancoId}"]`);
    const periodoSpan = document.querySelector(`.periodo-calculado[data-banco-id="${bancoId}"]`);
    
    const dataDivulgacao = divulgacaoInput.value;
    const diasColeta = parseInt(diasInput.value) || 2;
    
    if (dataDivulgacao) {
        const dataInicio = new Date(dataDivulgacao + 'T00:00:00');
        const dataFim = new Date(dataInicio);
        dataFim.setDate(dataFim.getDate() + diasColeta);
        
        const formatDate = (d) => d.toLocaleDateString('pt-BR');
        periodoSpan.textContent = `${formatDate(dataInicio)} a ${formatDate(dataFim)} (${diasColeta + 1} dias)`;
        periodoSpan.style.color = '#28a745';
        periodoSpan.style.fontWeight = 'bold';
    } else {
        periodoSpan.textContent = 'Defina a data de divulga√ß√£o';
        periodoSpan.style.color = '#6c757d';
        periodoSpan.style.fontWeight = 'normal';
    }
}

document.getElementById('config-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        email: document.getElementById('bw-email').value,
        password: document.getElementById('bw-password').value,
        project: document.getElementById('bw-project').value,
        query_name: document.getElementById('bw-query').value
    };
    
    try {
        const response = await fetch('/api/brandwatch-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Configura√ß√£o salva com sucesso!');
            document.getElementById('config-form').style.display = 'none';
            checkBrandwatchStatus();
        } else {
            alert('Erro ao salvar configura√ß√£o');
        }
    } catch (error) {
        alert('Erro: ' + error.message);
    }
});

document.getElementById('analise-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!bwConfigured) {
        alert('Configure a Brandwatch antes de executar a an√°lise');
        return;
    }
    
    const periodoRef = document.getElementById('periodo-ref').value.trim();
    if (!periodoRef) {
        alert('Defina o per√≠odo de refer√™ncia (ex: 1T2025)');
        return;
    }
    
    // Coletar dados de todos os bancos
    const bancosPeriodos = [];
    let hasError = false;
    
    bancosData.forEach(banco => {
        const divulgacaoInput = document.querySelector(`.banco-divulgacao[data-banco-id="${banco.id}"]`);
        const diasInput = document.querySelector(`.banco-dias-coleta[data-banco-id="${banco.id}"]`);
        
        const dataDivulgacao = divulgacaoInput.value;
        const diasColeta = parseInt(diasInput.value) || 2;
        
        if (!dataDivulgacao) {
            alert(`Defina a data de divulga√ß√£o para ${banco.nome}`);
            hasError = true;
            return;
        }
        
        bancosPeriodos.push({
            banco_id: banco.id,
            banco_nome: banco.nome,
            data_divulgacao: dataDivulgacao,
            dias_coleta: diasColeta
        });
    });
    
    if (hasError) return;
    
    const queryOverride = document.getElementById('query-override').value.trim();
    
    const data = {
        periodo_referencia: periodoRef,
        bancos: bancosPeriodos
    };
    
    if (queryOverride) {
        data.query_name = queryOverride;
    }
    
    // Mostrar progresso
    document.getElementById('progress-info').style.display = 'block';
    document.getElementById('btn-executar').disabled = true;
    document.getElementById('resultado-card').style.display = 'none';
    
    try {
        document.getElementById('progress-text').textContent = 'Extraindo men√ß√µes da Brandwatch...';
        
        const response = await fetch('/api/analises/executar-resultados', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        document.getElementById('progress-info').style.display = 'none';
        document.getElementById('btn-executar').disabled = false;
        
        if (result.success) {
            // Mostrar resultado
            const resultadoCard = document.getElementById('resultado-card');
            const resultadoContent = document.getElementById('resultado-content');
            
            let periodosHtml = '<h3>Per√≠odos de Coleta</h3><table class="table"><thead><tr><th>Banco</th><th>Divulga√ß√£o</th><th>Per√≠odo</th><th>Men√ß√µes</th></tr></thead><tbody>';
            
            result.periodos.forEach(p => {
                periodosHtml += `
                    <tr>
                        <td><strong>${p.banco_nome}</strong></td>
                        <td>${new Date(p.data_divulgacao).toLocaleDateString('pt-BR')}</td>
                        <td>${new Date(p.data_inicio).toLocaleDateString('pt-BR')} a ${new Date(p.data_fim).toLocaleDateString('pt-BR')}</td>
                        <td>${p.total_mencoes}</td>
                    </tr>
                `;
            });
            periodosHtml += '</tbody></table>';
            
            resultadoContent.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ An√°lise conclu√≠da com sucesso!</strong>
                </div>
                
                <div style="margin:20px 0;">
                    <p><strong>ID da An√°lise:</strong> #${result.analise_id}</p>
                    <p><strong>Per√≠odo de Refer√™ncia:</strong> ${result.periodo_referencia}</p>
                    <p><strong>Total de Men√ß√µes:</strong> ${result.total_mencoes}</p>
                </div>
                
                ${periodosHtml}
                
                <h3>Ranking IEDI</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Posi√ß√£o</th>
                            <th>Banco</th>
                            <th>IEDI Final</th>
                            <th>IEDI M√©dio</th>
                            <th>Volume</th>
                            <th>Positividade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${result.resultados.map((r, i) => `
                            <tr>
                                <td><strong>${i+1}¬∫</strong></td>
                                <td>${r.banco}</td>
                                <td><strong>${formatNumber(r.iedi_final)}</strong></td>
                                <td>${formatNumber(r.iedi_medio)}</td>
                                <td>${r.volume_total}</td>
                                <td>${formatNumber(r.positividade)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top:20px;">
                    <a href="/analise/${result.analise_id}" class="btn btn-primary">Ver Detalhes Completos</a>
                    <a href="/analises" class="btn btn-secondary">Ir para An√°lises</a>
                </div>
            `;
            
            resultadoCard.style.display = 'block';
            resultadoCard.scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Erro na an√°lise: ' + result.error);
        }
    } catch (error) {
        document.getElementById('progress-info').style.display = 'none';
        document.getElementById('btn-executar').disabled = false;
        alert('Erro ao executar an√°lise: ' + error.message);
    }
});

// Verificar status e carregar bancos ao carregar p√°gina
checkBrandwatchStatus();
loadBancos();
</script>
{% endblock %}
